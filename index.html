<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚²ãƒ¼ãƒ å‹Ÿé›†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 50px; }
        .container { max-width: 600px; margin-top: 30px; }
        .slot-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .member-pill { display: inline-block; background: #e9ecef; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; margin: 2px; }
        .role-tag { font-weight: bold; color: #0d6efd; margin-left: 4px; }
        .loading { text-align: center; margin-top: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h2 class="fw-bold">ğŸ® å‹Ÿé›†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
            <p class="text-muted">GitHubç‰ˆ (å®šå“¡4å)</p>
        </div>
        
        <div id="app">
            <div class="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // â˜…ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ï¼ˆæœ«å°¾ã® /exec ã¾ã§ï¼‰
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxbeMJg2LYiZu48lYpld5DyQ29Go8LKGmuog5jEGzPsVCspDEz5ZG__bvjt1fZubFW2/exec";

        window.onload = loadSlots;

        async function loadSlots() {
            try {
                // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
                const response = await fetch(GAS_API_URL + "?action=getSlots");
                const slots = await response.json();
                renderSlots(slots);
            } catch (e) {
                document.getElementById('app').innerHTML = 
                    `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>${e.message}</div>`;
            }
        }

        function renderSlots(slots) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (!slots || slots.length === 0) {
                app.innerHTML = '<div class="alert alert-secondary text-center">ç¾åœ¨ã€å‹Ÿé›†ä¸­ã®æ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            slots.forEach(slot => {
                const remain = slot.max - slot.current;
                const isFull = remain <= 0;
                
                let membersHtml = slot.members.length > 0 
                    ? slot.members.map(m => `<span class="member-pill">${escapeHtml(m.name)} <span class="role-tag">${escapeHtml(m.role)}</span></span>`).join('')
                    : '<small class="text-muted ms-1">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“</small>';

                const card = document.createElement('div');
                card.className = 'slot-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold text-dark">${slot.display}</h5>
                        <span class="badge ${isFull ? 'bg-secondary' : 'bg-primary'}">
                            ${isFull ? 'æº€å“¡' : 'ã‚ã¨ ' + remain + ' å'}
                        </span>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼:</small><br>
                        <div class="mt-1">${membersHtml}</div>
                    </div>
                    ${!isFull ? `
                        <div class="mt-3 pt-3 border-top row g-2">
                            <div class="col-5"><input type="text" class="form-control form-control-sm" id="name-${slot.id}" placeholder="åå‰"></div>
                            <div class="col-4">
                                <select class="form-select form-select-sm" id="role-${slot.id}">
                                    <option value="ALL">ä½•ã§ã‚‚</option>
                                    <option value="DPS">DPS</option>
                                    <option value="Tank">Tank</option>
                                    <option value="Healer">Healer</option>
                                </select>
                            </div>
                            <div class="col-3"><button onclick="book('${slot.id}', '${slot.display}')" class="btn btn-success btn-sm w-100">å‚åŠ </button></div>
                        </div>
                    ` : '<button class="btn btn-light w-100 text-muted" disabled>æº€å“¡</button>'}
                `;
                app.appendChild(card);
            });
        }

        async function book(slotId, displayTime) {
            const name = document.getElementById(`name-${slotId}`).value;
            const role = document.getElementById(`role-${slotId}`).value;
            if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (!confirm(`${displayTime} ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const btn = event.target;
            btn.disabled = true;
            btn.innerText = "...";

            // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ç‰¹æ®Šãªå½¢å¼)
            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // â˜…é‡è¦ï¼šGASã¸ã®POSTã¯no-corsãƒ¢ãƒ¼ãƒ‰ãŒå¿…è¦
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slotId, displayTime, userName: name, role })
                });
                
                // no-corsãƒ¢ãƒ¼ãƒ‰ã ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ãŒè¦‹ã‚Œãªã„ä»•æ§˜ãªã®ã§ã€
                // ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°æˆåŠŸã¨ã¿ãªã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
                alert("é€ä¿¡ã—ã¾ã—ãŸï¼(åæ˜ ã¾ã§æ•°ç§’ã‹ã‹ã‚Šã¾ã™)");
                setTimeout(loadSlots, 2000); 
                
            } catch (e) {
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message);
                btn.disabled = false;
            }
        }

        function escapeHtml(str) {
            return str ? str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : '';
        }
    </script>
</body>
</html>